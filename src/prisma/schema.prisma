generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String           @id @default(uuid())
  email         String           @unique
  password      String
  displayName   String
  role          String           @default("TRADER") // TRADER | ADMIN
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  tradingAccounts TradingAccount[]
}

model TradingAccount {
  id            String   @id @default(uuid())
  userId        String
  accountNumber String   @unique
  broker        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades        Trade[]
  traderMetrics TraderMetrics[]
}

model Trade {
  id              String   @id @default(uuid())
  tradingAccountId String
  symbol          String
  type            String
  volume          Float
  openPrice       Float
  closePrice      Float?
  profit          Float?
  openTime        DateTime
  closeTime       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tradingAccount  TradingAccount @relation(fields: [tradingAccountId], references: [id], onDelete: Cascade)
}

model TraderMetrics {
  id              String   @id @default(uuid())
  tradingAccountId String   @unique
  totalTrades     Int      @default(0)
  winningTrades   Int      @default(0)
  losingTrades    Int      @default(0)
  totalProfit     Float    @default(0)
  totalLoss       Float    @default(0)
  winRate         Float    @default(0)
  profitFactor    Float    @default(0)
  averageWin      Float    @default(0)
  averageLoss     Float    @default(0)
  largestWin      Float    @default(0)
  largestLoss     Float    @default(0)
  currentDrawdown Float    @default(0)
  maxDrawdown     Float    @default(0)
  sharpeRatio     Float    @default(0)
  periodStart     DateTime @default(now())
  periodEnd       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tradingAccount  TradingAccount @relation(fields: [tradingAccountId], references: [id], onDelete: Cascade)
}

model TraderScore {
  id              String   @id @default(uuid())
  tradingAccountId String   @unique
  tier            String
  rank            Int
  score           Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Tier {
  id          String   @id @default(uuid())
  name        String   @unique
  minScore    Float
  maxScore    Float?
  color       String?
  icon        String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Reward {
  id          String   @id @default(uuid())
  tier        String
  rewardType  String
  name        String
  description String?
  amount      Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  entitlements RewardEntitlement[]
}

model RewardEntitlement {
  id          String   @id @default(uuid())
  traderId    String
  rewardId    String
  rewardType  String
  amount      Float
  status      String   @default("PENDING")
  eligibleAt  DateTime
  expiresAt   DateTime?
  claimedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  reward      Reward   @relation(fields: [rewardId], references: [id], onDelete: Cascade)
}

model Mt5Trader {
  id            String               @id @default(uuid())
  externalId    String               @unique
  name          String
  accountStatus String
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  accounts      Mt5TradingAccount[]
  metrics       Mt5TraderMetrics[]
  score         Mt5TraderScore?

  @@map("mt5_traders")
}

model Mt5TradingAccount {
  id         String     @id @default(uuid())
  traderId   String
  externalId String     @unique
  balance    Float
  leverage   Int
  currency   String
  status     String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  trader     Mt5Trader  @relation(fields: [traderId], references: [id], onDelete: Cascade)
  trades     Mt5Trade[]

  @@index([traderId])
  @@map("mt5_trading_accounts")
}

model Mt5Trade {
  id         String            @id @default(uuid())
  externalId String            @unique
  accountId  String
  symbol     String
  volume     Float
  profitLoss Float
  fees       Float
  openTime   DateTime
  closeTime  DateTime?
  status     String
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  account    Mt5TradingAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@map("mt5_trades")
}

model Mt5TraderMetrics {
  id                String    @id @default(uuid())
  traderId          String    @unique
  profitFactor      Float
  winRate           Float
  drawdown          Float
  totalTradingDays  Int
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  trader            Mt5Trader @relation(fields: [traderId], references: [id], onDelete: Cascade)

  @@index([traderId])
  @@map("mt5_trader_metrics")
}

model Mt5TraderScore {
  id                String    @id @default(uuid())
  traderId          String    @unique
  consistencyScore  Float
  tier              String?
  rank              Int?
  eligible          Boolean   @default(false)
  lastCalculatedAt  DateTime
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  trader            Mt5Trader @relation(fields: [traderId], references: [id], onDelete: Cascade)

  @@index([rank])
  @@map("mt5_trader_scores")
}

model SnapshotRun {
  id          String           @id @default(uuid())
  runKey      String           @unique
  version     String
  label       String?
  createdAt   DateTime         @default(now())
  generatedAt DateTime?
  traders     TraderSnapshot[]

  @@map("snapshot_runs")
}

model TraderSnapshot {
  id               String       @id @default(uuid())
  snapshotId       String
  traderId         String
  externalTraderId String
  score            Float
  rank             Int
  tier             String
  badges           Json
  metrics          Json
  createdAt        DateTime     @default(now())
  snapshot         SnapshotRun  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@unique([snapshotId, traderId])
  @@index([snapshotId])
  @@index([tier, rank])
  @@map("trader_snapshots")
}
